<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Oliva Space üåø ‚Äî –±–∏—Ä–∂–∞ –º–∏–∫—Ä–æ–∑–∞–¥–∞—á</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app {
      flex: 1;
      padding: 18px 20px 24px;
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .logo {
      font-weight: 700;
      font-size: 18px;
    }

    .logo span {
      color: #22c55e;
    }

    .tagline {
      font-size: 12px;
      opacity: 0.9;
    }

    .balance-pill {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .balance-pill button {
      border: none;
      background: #22c55e;
      color: #020617;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.8);
      padding-bottom: 4px;
    }

    .tab {
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      opacity: 0.8;
      background: transparent;
      color: inherit;
    }

    .tab.active {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(148, 163, 184, 0.7);
      opacity: 1;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    .panel-header {
      margin-bottom: 8px;
    }

    .panel-header h2 {
      font-size: 16px;
      margin-bottom: 4px;
    }

    .panel-subtitle {
      font-size: 12px;
      opacity: 0.8;
    }

    .task-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .task {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 4px 10px;
      align-items: center;
    }

    .task-title {
      font-size: 13px;
      font-weight: 500;
    }

    .task-meta {
      font-size: 11px;
      opacity: 0.75;
    }

    .task-status {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      justify-self: flex-end;
      text-transform: lowercase;
    }

    .status-open {
      background: rgba(34, 197, 94, 0.16);
      color: #4ade80;
    }

    .task-actions {
      grid-column: 1 / -1;
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: transparent;
      color: #e5e7eb;
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
    }

    .btn-primary {
      background: #22c55e;
      color: #020617;
      border-color: #22c55e;
    }

    .btn-ghost {
      background: transparent;
    }

    .btn[disabled] {
      opacity: 0.4;
      cursor: default;
    }

    .empty-state,
    .error-state {
      margin-top: 8px;
      font-size: 12px;
      opacity: 0.7;
    }

    .error-state {
      color: #f97373;
      opacity: 1;
    }

    footer {
      padding: 10px 20px 18px;
      font-size: 11px;
      opacity: 0.65;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ====== –®–ê–ü–ö–ê ====== -->
    <header>
      <div>
        <div class="logo">
          Oliva <span>Space</span>
        </div>
        <div class="tagline">–º–∏–∫—Ä–æ–∑–∞–¥–∞—á–∏ ‚Ä¢ –±—ã—Å—Ç—Ä—ã–µ –¥–µ–Ω—å–≥–∏</div>
      </div>

      <div class="balance-pill" id="balance-label">
        üí∞ –ë–∞–ª–∞–Ω—Å: <span id="balance-value">0 ‚ÇΩ</span>
      </div>
    </header>

    <!-- ====== –í–ö–õ–ê–î–ö–ò ====== -->
    <nav class="tabs">
      <button class="tab active" data-tab="market">üõí –ú–∞—Ä–∫–µ—Ç –∑–∞–¥–∞—á</button>
      <button class="tab" data-tab="my-tasks">üìã –ú–æ–∏ –∑–∞–¥–∞—á–∏</button>
      <button class="tab" data-tab="my-works">üõ†Ô∏è –ú–æ–∏ —Ä–∞–±–æ—Ç—ã</button>
      <button class="tab" data-tab="chat">üí¨ –ß–∞—Ç</button>
    </nav>

    <!-- ====== –°–û–î–ï–†–ñ–ò–ú–û–ï –í–ö–õ–ê–î–û–ö ====== -->
    <main>
      <!-- –ú–ê–†–ö–ï–¢ –ó–ê–î–ê–ß -->
      <section class="panel active" data-panel="market">
        <div class="panel-header">
          <h2>–ú–∞—Ä–∫–µ—Ç –∑–∞–¥–∞—á</h2>
          <p class="panel-subtitle">
            –ó–¥–µ—Å—å –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏ –æ—Ç –∑–∞–∫–∞–∑—á–∏–∫–æ–≤ Oliva Space.
          </p>
        </div>

        <div id="market-tasks" class="task-list">
          <!-- –ó–∞–¥–∞—á–∏ –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ /api/tasks -->
        </div>

        <div class="empty-state" id="market-empty" style="display:none;">
          –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á. –î–æ–±–∞–≤—å –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π <b>/newtask</b>.
        </div>

        <div class="error-state" id="market-error" style="display:none;">
          –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏. –ü–æ–ø—Ä–æ–±—É–π –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.
        </div>
      </section>

      <!-- –ú–û–ò –ó–ê–î–ê–ß–ò –ö–ê–ö –ó–ê–ö–ê–ó–ß–ò–ö–ê -->
      <section class="panel" data-panel="my-tasks">
        <div class="panel-header">
          <h2>–ú–æ–∏ –∑–∞–¥–∞—á–∏</h2>
          <p class="panel-subtitle">
            –ó–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã —Å–æ–∑–¥–∞–ª –∫–∞–∫ –∑–∞–∫–∞–∑—á–∏–∫.
          </p>
        </div>

        <div class="empty-state">
          –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Å–ø–∏—Å–æ–∫ —Ç–≤–æ–∏—Ö –∑–∞–¥–∞—á –∏–∑ –±–æ—Ç–∞ (–∫–æ–º–∞–Ω–¥—ã <b>/newtask</b>, <b>/tasks</b>).
        </div>
      </section>

      <!-- –ú–û–ò –†–ê–ë–û–¢–´ –ö–ê–ö –ò–°–ü–û–õ–ù–ò–¢–ï–õ–Ø -->
      <section class="panel" data-panel="my-works">
        <div class="panel-header">
          <h2>–ú–æ–∏ —Ä–∞–±–æ—Ç—ã</h2>
          <p class="panel-subtitle">
            –ó–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –≤–∑—è–ª –≤ —Ä–∞–±–æ—Ç—É –∫–∞–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å.
          </p>
        </div>

        <div class="empty-state">
          –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥—É—Ç –∑–∞–¥–∞—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –≤–∑—è–ª —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π <b>/take</b>.
        </div>
      </section>

      <!-- –ß–ê–¢ –ò–°–ü–û–õ–ù–ò–¢–ï–õ–Ø –° –ó–ê–ö–ê–ó–ß–ò–ö–û–ú -->
      <section class="panel" data-panel="chat">
        <div class="panel-header">
          <h2>–ß–∞—Ç</h2>
          <p class="panel-subtitle">
            –ú–∏–Ω–∏-—á–∞—Ç –º–µ–∂–¥—É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º –∏ –∑–∞–∫–∞–∑—á–∏–∫–æ–º –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–µ.
          </p>
        </div>

        <div class="empty-state">
          –ß–∞—Ç –º—ã –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ. –ü–æ–∫–∞ –æ–±—â–µ–Ω–∏–µ –∏–¥—ë—Ç —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.
        </div>
      </section>
    </main>
  </div>

  <footer>
    Oliva Space üåø ¬∑ Telegram-–±–æ—Ç + –≤–µ–±-–ø–∞–Ω–µ–ª—å –Ω–∞ –æ–¥–Ω–æ–º –±—ç–∫–µ–Ω–¥–µ. –î–µ–π—Å—Ç–≤–∏—è —Å –∑–∞–¥–∞—á–∞–º–∏ —Å–µ–π—á–∞—Å –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞.
  </footer>

  <script>
    // ===== –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ =====
    const tabButtons = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.panel');

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;

        tabButtons.forEach(b => b.classList.toggle('active', b === btn));
        panels.forEach(p => p.classList.toggle('active', p.dataset.panel === tab));
      });
    });

    // ===== –ú–∞—Ä–∫–µ—Ç –∑–∞–¥–∞—á: –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ /api/tasks =====
    const marketList  = document.getElementById('market-tasks');
    const marketEmpty = document.getElementById('market-empty');
    const marketError = document.getElementById('market-error');

    async function loadMarket() {
      if (!marketList) return;

      marketList.innerHTML = '';
      marketEmpty.style.display = 'none';
      marketError.style.display = 'none';

      try {
        const res = await fetch('/api/tasks');
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const tasks = await res.json();

        if (!Array.isArray(tasks) || tasks.length === 0) {
          marketEmpty.style.display = 'block';
          return;
        }

        // –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞—á–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ "open"
        const openTasks = tasks.filter(t => t.status === 'open');

        if (openTasks.length === 0) {
          marketEmpty.innerHTML =
            '–°–µ–π—á–∞—Å –Ω–µ—Ç –∑–∞–¥–∞—á –≤ —Å—Ç–∞—Ç—É—Å–µ <b>open</b>.<br/>–î–æ–±–∞–≤—å –Ω–æ–≤—É—é —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π <b>/newtask</b>.';
          marketEmpty.style.display = 'block';
          return;
        }

        openTasks.forEach(task => {
          const item = document.createElement('div');
          item.className = 'task';

          const title = document.createElement('div');
          title.className = 'task-title';
          title.textContent = (task.text || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏').trim();

          const meta = document.createElement('div');
          meta.className = 'task-meta';
          const price = task.price != null ? task.price + ' ‚ÇΩ' : '–±–µ–∑ —Ü–µ–Ω—ã';
          meta.textContent = `#${task.id} ‚Ä¢ ${price}`;

          const status = document.createElement('div');
          status.className = 'task-status status-open';
          status.textContent = 'open';

          const actions = document.createElement('div');
          actions.className = 'task-actions';

          const btnTake = document.createElement('button');
          btnTake.className = 'btn btn-primary';
          btnTake.textContent = '–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É (—á–µ—Ä–µ–∑ –±–æ—Ç–∞)';
          btnTake.disabled = true; // –≤–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏–º API –¥–ª—è –≤–∑—è—Ç–∏—è –∑–∞–¥–∞—á–∏

          const btnMore = document.createElement('button');
          btnMore.className = 'btn btn-ghost';
          btnMore.textContent = '–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
          btnMore.disabled = true;

          actions.appendChild(btnTake);
          actions.appendChild(btnMore);

          item.appendChild(title);
          item.appendChild(status);
          item.appendChild(meta);
          item.appendChild(actions);

          marketList.appendChild(item);
        });
      } catch (err) {
        console.error(err);
        marketError.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏: ' + err.message;
        marketError.style.display = 'block';
      }
    }

    loadMarket();
  </script>
</body>
</html>
